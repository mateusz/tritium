<!DOCTYPE html>
<html>
<head>
    <title>Tritium Game</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: monospace;
            background-color: #1e1e1e;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        #game-container {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            background-color: #2d2d2d;
        }
        #output {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #555;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #0d0d0d;
            white-space: pre-wrap;
        }
        #prompt {
            color: #4caf50;
            margin-bottom: 5px;
        }
        #input-container {
            display: flex;
            margin-top: 10px;
        }
        #input {
            flex-grow: 1;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 5px;
            font-family: monospace;
        }
        button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            margin-left: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 10px;
            padding: 5px;
            border-radius: 3px;
            display: none;
        }
        .success {
            background-color: #4caf50;
            color: white;
        }
        .error {
            background-color: #f44336;
            color: white;
        }
        .loading {
            text-align: center;
            margin: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Tritium Game</h1>
        <div id="loading" class="loading">Loading Pyodide and game files...</div>
        <div id="game-ui" style="display: none;">
            <div id="output"></div>
            <div id="prompt"></div>
            <div id="input-container">
                <input type="text" id="input" placeholder="Enter command..." autocomplete="off">
                <button id="submit">Submit</button>
                <button id="save">Save Game</button>
            </div>
            <div id="status"></div>
        </div>
    </div>

    <script>
        // Global variables
        let pyodide;
        let inputElement = document.getElementById('input');
        let outputElement = document.getElementById('output');
        let promptElement = document.getElementById('prompt');
        let submitButton = document.getElementById('submit');
        let saveButton = document.getElementById('save');
        let statusElement = document.getElementById('status');
        let gameUI = document.getElementById('game-ui');
        let loadingElement = document.getElementById('loading');

        // Function to print output to the game console
        function printOutput(text) {
            outputElement.innerHTML += text + '<br>';
            outputElement.scrollTop = outputElement.scrollHeight;
        }

        // Function to clear the output console
        function clearOutput() {
            outputElement.innerHTML = '';
        }

        // Function to set the prompt text
        function setPrompt(text) {
            promptElement.innerHTML = text;
        }

        // Function to set the input value
        function setInputValue(text) {
            inputElement.value = text;
        }

        // Function to show status messages
        function showSaveStatus(message, type) {
            statusElement.textContent = message;
            statusElement.className = type;
            statusElement.style.display = 'block';
            
            // Hide after 3 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // Function to show errors
        function showError(message) {
            showSaveStatus(message, 'error');
        }

        // Function to enable history navigation
        function enableHistoryNavigation(enabled) {
            if (enabled) {
                // History navigation is handled by keyboard events
            }
        }

        // Handle keyboard navigation for command history
        inputElement.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (pyodide && pyodide.globals) {
                    try {
                        pyodide.globals.history_up();
                    } catch (error) {
                        console.error("Error in history_up:", error);
                    }
                }
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (pyodide && pyodide.globals) {
                    try {
                        pyodide.globals.history_down();
                    } catch (error) {
                        console.error("Error in history_down:", error);
                    }
                }
            } else if (event.key === 'Enter') {
                event.preventDefault();
                submitInput();
            }
        });

        // Function to submit input
        function submitInput() {
            const inputText = inputElement.value;
            if (inputText.trim() !== '') {
                // Display the input in the output area
                printOutput(`<span style="color: #4caf50;">${promptElement.innerHTML}</span> ${inputText}`);
                
                // Pass the input to Python
                if (pyodide && pyodide.globals) {
                    try {
                        pyodide.globals.handle_user_input(inputText);
                    } catch (error) {
                        console.error("Error handling input:", error);
                        printOutput(`<span style="color: red;">Error: ${error.message}</span>`);
                    }
                }
                
                // Clear the input field
                inputElement.value = '';
            }
        }

        // Set up the submit button
        submitButton.addEventListener('click', submitInput);

        // Set up the save button
        saveButton.addEventListener('click', function() {
            if (pyodide && pyodide.globals) {
                try {
                    pyodide.globals.save_game_wrapper();
                } catch (error) {
                    console.error("Error saving game:", error);
                    showSaveStatus(`Error: ${error.message}`, "error");
                }
            }
        });

        // Initialize and load Pyodide
        async function main() {
            try {
                // Load Pyodide
                pyodide = await loadPyodide();
                printOutput("Pyodide loaded successfully!");
                
                // Install required packages
                await pyodide.loadPackagesFromImports(`
                    import pickle
                    import base64
                    import asyncio
                `);
                
                // Load the bundled game file
                printOutput("Loading bundled game file...");
                try {
                    const response = await fetch('tritium_bundle.py');
                    if (response.status === 200) {
                        const bundleCode = await response.text();
                        
                        // Save the code to the filesystem
                        pyodide.FS.writeFile('tritium_bundle.py', bundleCode);
                        printOutput("Game code loaded successfully!");
                        
                        // Make Python functions directly accessible in JavaScript
                        await pyodide.runPythonAsync(`
                            import sys
                            from pyodide.ffi import to_js
                            
                            # Ensure our Python functions are callable from JS
                            def expose_functions():
                                import tritium_bundle
                                
                                # These are the functions we want to expose
                                global handle_user_input, history_up, history_down, save_game_wrapper
                                handle_user_input = tritium_bundle.handle_user_input
                                history_up = tritium_bundle.history_up
                                history_down = tritium_bundle.history_down
                                save_game_wrapper = tritium_bundle.save_game_wrapper
                                
                                # Mark these as globals to ensure they're available to JS
                                to_js({"handle_user_input": handle_user_input,
                                       "history_up": history_up,
                                       "history_down": history_down,
                                       "save_game_wrapper": save_game_wrapper})
                            
                            expose_functions()
                        `);
                        
                        // Now start the game
                        await pyodide.runPythonAsync(`
                            try:
                                # Import the bundled code
                                import tritium_bundle
                                
                                # Now start the game
                                result = tritium_bundle.start_game()
                                print(f"Game started with result: {result}")
                            except Exception as e:
                                import traceback
                                traceback.print_exc()
                                print(f"Error: {str(e)}")
                        `);
                        
                        // Show the game UI
                        loadingElement.style.display = 'none';
                        gameUI.style.display = 'block';
                        
                        // Focus on the input
                        inputElement.focus();
                    } else {
                        throw new Error(`Failed to load game bundle: HTTP ${response.status}`);
                    }
                } catch (fetchError) {
                    console.error("Error loading bundle:", fetchError);
                    loadingElement.textContent = `Error loading game code: ${fetchError.message}`;
                    loadingElement.style.color = 'red';
                }
                
            } catch (error) {
                console.error("Error initializing game:", error);
                loadingElement.textContent = `Error: ${error.message}`;
                loadingElement.style.color = 'red';
            }
        }

        // Load Pyodide script
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js";
        script.onload = () => {
            main();
        };
        document.head.appendChild(script);
    </script>
</body>
</html> 